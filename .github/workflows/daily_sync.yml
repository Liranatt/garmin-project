name: Daily Health Sync
on:
  schedule:
    - cron: '0 6 * * *'  # Every Day 06:00 UTC
  workflow_dispatch:       # Manual trigger from GitHub UI

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Restore garth session
        run: |
          mkdir -p ~/.garth
          if [ -n "${{ secrets.GARTH_SESSION }}" ]; then
            echo '${{ secrets.GARTH_SESSION }}' | base64 -d > ~/.garth/oauth1_token.json || true
          fi
          if [ -n "${{ secrets.GARTH_SESSION_OAUTH2 }}" ]; then
            echo '${{ secrets.GARTH_SESSION_OAUTH2 }}' | base64 -d > ~/.garth/oauth2_token.json || true
          fi

      - name: Run weekly sync
        env:
          POSTGRES_CONNECTION_STRING: ${{ secrets.POSTGRES_CONNECTION_STRING }}
          GARMIN_EMAIL: ${{ secrets.GARMIN_EMAIL }}
          GARMIN_PASSWORD: ${{ secrets.GARMIN_PASSWORD }}
          GOOGLE_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          EMAIL_APP_PASSWORD: ${{ secrets.EMAIL_APP_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
          GARTH_HOME: ~/.garth
        working-directory: src
        run: |
          echo "Debugging Environment Variables:"
          if [ -z "${POSTGRES_CONNECTION_STRING}" ]; then
            echo "❌ POSTGRES_CONNECTION_STRING is EMPTY"
          else
            echo "✅ POSTGRES_CONNECTION_STRING is SET (length: ${#POSTGRES_CONNECTION_STRING})"
          fi
          python weekly_sync.py --days 2

      - name: Save garth session
        if: always()
        run: |
          if [ -f ~/.garth/oauth1_token.json ]; then
            echo "GARTH_SESSION=$(base64 -w0 ~/.garth/oauth1_token.json)" >> $GITHUB_ENV
          fi
          if [ -f ~/.garth/oauth2_token.json ]; then
            echo "GARTH_SESSION_OAUTH2=$(base64 -w0 ~/.garth/oauth2_token.json)" >> $GITHUB_ENV
          fi
